<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>威斯康星大学麦迪逊分校课程评价</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
            crossorigin="anonymous" />
        <link href="../styles.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    </head>

    <body>
        <nav
            class="navbar navbar-expand-lg navbar-light"
            style="
                background-color: skyblue;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            ">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold" href="/">李弘政的主页</a>
                <button
                    class="navbar-toggler"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto" id="dynamic-menu">
                        <!-- Menu items will be dynamically inserted here -->
                    </ul>
                </div>
            </div>
        </nav>

        <section class="container mt-5">
            <h1 id="review-title" class="mb-4 text-primary">
                <strong>课程评价</strong>
            </h1>

            <section id="course-table"></section>

            <section
                id="course-review-section"
                class="container mt-5"></section>
        </section>

        <footer class="bg-light text-dark py-3 position-sticky mt-auto">
            <p class="text-center">
                感谢您访问我的网站。<br />
                如有任何问题或建议，请随时<a
                    href="mailto:hongzheng@cs.wisc.edu"
                    class="text-decoration-none text-primary fw-bold"
                    >联系我</a
                >。
            </p>
        </footer>

        <!-- Menu Script -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Modified generateMenu function for Chinese version
            function generateMenu() {
                fetch("menus.json")
                    .then((response) => response.json())
                    .then((data) => {
                        const menuContainer =
                            document.getElementById("dynamic-menu");
                        data.menuItems.forEach((item) => {
                            const li = document.createElement("li");
                            li.className = "nav-item";

                            if (item.type === "dropdown") {
                                li.classList.add("dropdown");
                                const a = document.createElement("a");
                                a.className = "nav-link dropdown-toggle";
                                a.href = "#";
                                a.id = "navbarDropdown";
                                a.role = "button";
                                a.setAttribute("data-bs-toggle", "dropdown");
                                a.setAttribute("aria-expanded", "false");
                                a.textContent = item.text;

                                const ul = document.createElement("ul");
                                ul.className = "dropdown-menu";
                                ul.setAttribute(
                                    "aria-labelledby",
                                    "navbarDropdown",
                                );

                                item.items.forEach((subItem) => {
                                    const subLi = document.createElement("li");
                                    const subA = document.createElement("a");
                                    subA.className = "dropdown-item";
                                    subA.href = subItem.href;
                                    subA.textContent = subItem.text;
                                    subLi.appendChild(subA);
                                    ul.appendChild(subLi);
                                });

                                li.appendChild(a);
                                li.appendChild(ul);
                            } else if (item.type === "link") {
                                const a = document.createElement("a");
                                a.className = "nav-link";
                                a.href = item.href;
                                a.textContent = item.text;
                                li.appendChild(a);
                            }

                            menuContainer.appendChild(li);
                        });

                        // Add language switcher
                        const languageSwitcher = document.createElement("li");
                        languageSwitcher.className = "nav-item";

                        const switcherLink = document.createElement("a");
                        switcherLink.className = "nav-link";
                        switcherLink.href = "../course-review.html";
                        switcherLink.textContent = "English";
                        switcherLink.addEventListener("click", function () {
                            try {
                                localStorage.setItem("preferredLanguage", "en");
                            } catch (e) {
                                // Silently fail if localStorage unavailable
                            }
                        });

                        languageSwitcher.appendChild(switcherLink);
                        menuContainer.appendChild(languageSwitcher);
                    });
            }

            // Initialize menu
            generateMenu();
        </script>
        <script>
            // Modified course-review.js for Chinese version
            fetch("courses.json")
                .then((response) => response.json())
                .then((data) => {
                    // Create and add the navigation table
                    const tableNode = createCourseTable(data.courses);
                    document
                        .getElementById("course-table")
                        .appendChild(tableNode);

                    // Add course reviews
                    data.courses.forEach((course, index) => {
                        const courseNode = courseToNode(course, index);
                        document
                            .getElementById("course-review-section")
                            .appendChild(courseNode);
                    });
                });

            const defaultDisplayCount = 5;

            function courseToNode(course, index) {
                const courseNode = document.createElement("div");
                courseNode.className = "row align-items-start project mb-4";
                courseNode.id = `course-${index}`;

                // Create image column (left side)
                const courseImageNode = document.createElement("div");
                courseImageNode.className = "col-md-4 col-sm-12 mb-3";

                // Create image wrapper for aspect ratio
                const imageWrapper = document.createElement("div");
                imageWrapper.className = "position-relative h-100 w-100";
                imageWrapper.style.minHeight = "200px";

                const courseImage = document.createElement("img");
                courseImage.src = "../" + course.image;
                courseImage.className =
                    "img-fluid rounded w-100 h-100 object-fit-cover";
                courseImage.style.position = "relative";
                courseImage.alt = course.course_code;

                imageWrapper.appendChild(courseImage);
                courseImageNode.appendChild(imageWrapper);

                // Create content column (right side)
                const contentNode = document.createElement("div");
                contentNode.className = "col-md-8 col-sm-12";

                const courseTitle = document.createElement("h2");
                courseTitle.textContent = course.course_code;
                contentNode.appendChild(courseTitle);

                const newBadgesDivNode = document.createElement("div");
                newBadgesDivNode.className = "d-flex flex-wrap gap-2 mb-3";

                const courseSemester = document.createElement("p");
                courseSemester.className = "badge text-bg-secondary m-0";
                courseSemester.innerText = course.semester;
                newBadgesDivNode.appendChild(courseSemester);

                const courseHours = document.createElement("p");
                courseHours.className = "badge text-bg-secondary m-0";
                courseHours.innerText = "学时: ~" + course.hours + "小时";
                newBadgesDivNode.appendChild(courseHours);

                if (course.instructor) {
                    const courseInstructor = document.createElement("p");
                    courseInstructor.className = "badge text-bg-secondary m-0";
                    courseInstructor.innerText = "教师: " + course.instructor;
                    newBadgesDivNode.appendChild(courseInstructor);
                }
                contentNode.appendChild(newBadgesDivNode);

                // Render reviews as markdown
                if (Array.isArray(course.review)) {
                    course.review.forEach((reviewText) => {
                        const reviewElem = document.createElement("div");
                        reviewElem.innerHTML = window.marked
                            ? marked.parse(reviewText)
                            : reviewText;
                        contentNode.appendChild(reviewElem);
                    });
                }

                courseNode.appendChild(courseImageNode);
                courseNode.appendChild(contentNode);

                return courseNode;
            }

            function createCourseTable(courses) {
                const tableSection = document.createElement("div");
                tableSection.className = "container mb-4";

                // Create entries per page selector
                const selectorWrapper = document.createElement("div");
                selectorWrapper.className =
                    "d-flex align-items-center mb-3 gap-2";

                const selectorLabel = document.createElement("label");
                selectorLabel.textContent = "显示条目: ";

                const selector = document.createElement("select");
                selector.className = "form-select w-auto";
                [5, 10, 15, 20, "全部"].forEach((value) => {
                    const option = document.createElement("option");
                    option.value = value === "全部" ? courses.length : value;
                    option.textContent = value;
                    if (value === defaultDisplayCount) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });

                selectorWrapper.appendChild(selectorLabel);
                selectorWrapper.appendChild(selector);
                tableSection.appendChild(selectorWrapper);

                // Create table
                const table = document.createElement("table");
                table.className = "table table-hover";

                // Create table header
                const thead = document.createElement("thead");
                thead.className = "table-light";
                const headerRow = document.createElement("tr");
                ["课程代码", "学期"].forEach((headerText) => {
                    const th = document.createElement("th");
                    th.scope = "col";
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                // Create table body
                const tbody = document.createElement("tbody");
                table.appendChild(tbody);
                tableSection.appendChild(table);

                // Create pagination container
                const paginationContainer = document.createElement("div");
                paginationContainer.className =
                    "d-flex justify-content-between align-items-center mt-3";

                const pageInfo = document.createElement("div");
                paginationContainer.appendChild(pageInfo);

                const pagination = document.createElement("ul");
                pagination.className = "pagination mb-0";
                paginationContainer.appendChild(pagination);

                tableSection.appendChild(paginationContainer);

                // Function to update table content
                function updateTable(entriesPerPage, currentPage = 1) {
                    // Clear existing tbody
                    tbody.innerHTML = "";

                    // Calculate start and end indices
                    const start = (currentPage - 1) * entriesPerPage;
                    const end = Math.min(
                        start + entriesPerPage,
                        courses.length,
                    );

                    // Update page info text
                    pageInfo.textContent = `显示第 ${
                        start + 1
                    } 到 ${end} 条，共 ${courses.length} 条记录`;

                    // Add rows for current page
                    for (let i = start; i < end; i++) {
                        const course = courses[i];
                        const row = document.createElement("tr");
                        row.style.cursor = "pointer";

                        row.addEventListener("click", () => {
                            document
                                .getElementById(`course-${i}`)
                                .scrollIntoView({
                                    behavior: "smooth",
                                    block: "start",
                                });

                            const courseElement = document.getElementById(
                                `course-${i}`,
                            );
                            courseElement.style.transition =
                                "background-color 0.5s";
                            courseElement.style.backgroundColor = "#fff3cd";
                            setTimeout(() => {
                                courseElement.style.backgroundColor = "";
                            }, 1500);
                        });

                        const codeCell = document.createElement("td");
                        codeCell.textContent = course.course_code;
                        row.appendChild(codeCell);

                        const semesterCell = document.createElement("td");
                        semesterCell.textContent = course.semester;
                        row.appendChild(semesterCell);

                        tbody.appendChild(row);
                    }

                    // Update pagination
                    pagination.innerHTML = "";
                    const totalPages = Math.ceil(
                        courses.length / entriesPerPage,
                    );

                    if (totalPages > 1) {
                        // Previous button
                        const prevLi = document.createElement("li");
                        prevLi.className = `page-item ${
                            currentPage === 1 ? "disabled" : ""
                        }`;
                        const prevLink = document.createElement("a");
                        prevLink.className = "page-link";
                        prevLink.href = "#";
                        prevLink.textContent = "上一页";
                        prevLink.addEventListener("click", (e) => {
                            e.preventDefault();
                            if (currentPage > 1) {
                                updateTable(entriesPerPage, currentPage - 1);
                            }
                        });
                        prevLi.appendChild(prevLink);
                        pagination.appendChild(prevLi);

                        // Page numbers
                        for (let i = 1; i <= totalPages; i++) {
                            const li = document.createElement("li");
                            li.className = `page-item ${
                                i === currentPage ? "active" : ""
                            }`;
                            const link = document.createElement("a");
                            link.className = "page-link";
                            link.href = "#";
                            link.textContent = i;
                            link.addEventListener("click", (e) => {
                                e.preventDefault();
                                updateTable(entriesPerPage, i);
                            });
                            li.appendChild(link);
                            pagination.appendChild(li);
                        }

                        // Next button
                        const nextLi = document.createElement("li");
                        nextLi.className = `page-item ${
                            currentPage === totalPages ? "disabled" : ""
                        }`;
                        const nextLink = document.createElement("a");
                        nextLink.className = "page-link";
                        nextLink.href = "#";
                        nextLink.textContent = "下一页";
                        nextLink.addEventListener("click", (e) => {
                            e.preventDefault();
                            if (currentPage < totalPages) {
                                updateTable(entriesPerPage, currentPage + 1);
                            }
                        });
                        nextLi.appendChild(nextLink);
                        pagination.appendChild(nextLi);
                    }
                }

                // Add event listener for entries per page selector
                selector.addEventListener("change", (e) => {
                    updateTable(parseInt(e.target.value));
                });

                // Initialize table with default entries per page
                updateTable(defaultDisplayCount);

                return tableSection;
            }
        </script>
    </body>
</html>
